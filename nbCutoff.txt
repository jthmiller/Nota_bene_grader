##remove the below '#' to install the package before opening xlsx or httr
#install.packages('xlsx')
library(xlsx)
#install.packages('httr')
library(httr)

##Download the latest roster and put the path to this file
roster <- "BIS_002A_A01_A17_WQ_2016_2_10_16.xls"

## Set Parameters for Analysis
## Make a folder to hold all NB files- paste its path below
# setwd("/Users/jeffreymiller/Desktop/NB Grades")

## Change only once
instruct <- "Kopp"
# Put login info for Nota Bene here:
EMAIL <- ""
PASSWORD <- ""

# Set User Agent string so it doesn't look like we're scraping data with R.
# Change to something else (e.g., Chrome) if desired. Should have no effect
# on anything.
ua <- add_headers("Chrome" = "Mozilla/5.0 (X11; Linux x86_64; rv:43.0) Gecko/20100101 Firefox/43.0")

# Get ckey for all subsequent requests.
l <- POST(url = "http://nb.mit.edu/pdf4/rpc?guest=1",
    body = list(a = paste('{"email":"', EMAIL , '","password":"', PASSWORD, '"}', sep = ""),
        cid = 0,
        f = 'login_user'), 
    encode = "form",
    config = c(ua))
login_data <- content(l, type = "application/json")
ckey <- login_data$payload$ckey

# Set ckey cookie
ckey_cookie <- set_cookies(ckey = ckey)

# Set rest of cookies (server returns the rest of the cookies when you request
# the page with a ckey). Still need to use ckey_cookie in future requests,
# though.
GET(url = "http://nb.mit.edu", ua, ckey_cookie)
 
# Get ids for nota bene assignments
nota_bene_assigs <- POST(url = paste("http://nb.mit.edu/pdf4/rpc?guest=1&ckey=", ckey, sep = ""),
    body = list(a = '{"types":["ensembles", "folders", "files", "sections"]}',
        cid = 0,
        f = 'getObjects'),
    encode = "form",
    config = c(ckey_cookie, ua))
 
# Display nota bene ids (internal to the nota bene website) so user can select
# the one for which to retrieve data
nb_assig_data <- content(nota_bene_assigs, type = "application/json")

# Figure out which class to get nota benes for
class_ids <- data.frame(classes = mapply(function(x) nb_assig_data$payload$ensembles[[x]]$name, names(nb_assig_data$payload$ensembles)))
print(class_ids)

class_id_is_valid <- function(class_id) ! is.null(nb_assig_data$payload$ensembles[[as.character(class_id)]])
repeat {
    class_id <- as.numeric(readline("Enter the id of the class: "))
    if (class_id_is_valid(class_id)) break
    # Give error message for invalid ids:
    cat("Invalid Class ID entered. Please try again.\n")
}

# Figure out which nota bene to retrieve
titles_ids <- data.frame(titles = mapply(function(x) nb_assig_data$payload$files[[x]]$title, Filter(function(x) nb_assig_data$payload$files[[x]]$id_ensemble == class_id, names(nb_assig_data$payload$files))))
print(titles_ids)

nb_id_is_valid <- function(nb_id) ! is.null(nb_assig_data$payload$files[[as.character(nb_id)]])
repeat {
    nb_id <- as.numeric(readline("Enter the id of the Nota Bene you wish to retrieve: "))
    if (nb_id_is_valid(nb_id)) break
    # Give error message for invalid ids:
    cat("Invalid ID entered. Please try again.\n")
}

# Get the due date for the retrieved nota bene (assuming the displayed time
# is written in Pacific Time). Convert to UTC because comment submission times
# are stored in UTC.
due_date <- as.POSIXct(
    format(
        as.POSIXct(nb_assig_data$payload$files[[as.character(nb_id)]]$due,
        format = "%FT%T",
        tz = "America/Los_Angeles"),
     tz = "UTC"),
tz = "UTC")

# Should be exactly the same as the class id entered above
ensemble_id <- as.numeric(nb_assig_data$payload$files[[as.character(nb_id)]]$id_ensemble)

cat("Getting data. Please wait...\n")

# Get the data for all students
students <- POST(url = paste("http://nb.mit.edu/pdf4/rpc?ckey=", ckey, sep = ""),
    body = list(a = paste('{"id_ensemble":', ensemble_id, '}', sep = ""),
        cid = format(Sys.time(), "%Y-%m-%d %H:%M:%OS6"),
        f = 'getMembers'),
    encode = "form",
    config = c(ckey_cookie, ua))
student_data <- content(students, type = "application/json")
cat("Keep waiting...\n")

# Get the data for the requested nota bene
nota_bene <- POST(url = paste("http://nb.mit.edu/pdf4/rpc?ckey=", ckey, sep = ""),
    body = list(a = paste('{"file":', nb_id, '}', sep = ""),
        cid = format(Sys.time(), "%Y-%m-%d %H:%M:%OS6"),
        f = 'getNotes'),
    encode = "form",
    config = c(ckey_cookie, ua))
nb_data <- content(nota_bene, type = "application/json")
cat("Keep waiting...\n")

# Get just the full name, email, creation time, and comments
get_data <- function(comment) {
    student_info <- student_data$payload[[as.character(comment$id_author)]]
    c(student_info$firstname, student_info$lastname, student_info$email, comment$ctime, comment$body)
}
data <- t(sapply(nb_data$payload$comments, get_data))
rownames(data) <- data[,3]
colnames(data) <- c("First Name", "Last Name", "Email", "Time", "Comment")

# Needed for Smartsite-friendly output
assign_num <- as.numeric(readline("Enter the assignment number (1 - 10): "))

cat("Calculating scores...")

#set workfile name from assignment name
nb_file <- nb_assig_data$payload$files[[as.character(nb_id)]]$title
outfilename <- substr(basename(nb_file), 1, nchar(basename(nb_file)) - 4)

###Split out worksheet into in objects
rost <- read.xlsx(roster, 1)

# As of 3/3/16, on the Nota Bene website, the character count, comment count,
# and word count statistics for the XLS file (when one clicks Download as XLS)
# are calculated within a database query. See Line 312 in
# github:nbproject/nbproject/apps/base/annotations.py in commit c6bb13a (Jan 10,
# 2016) for the relevant query.
# URL: https://github.com/nbproject/nbproject/blob/c6bb13ae30d992d03d9fb4ecad75e91af5208df4/apps/base/annotations.py#L312
#
# Comment count is calculated using: count(v.id)
# Word count is calculated using whitespace: sum(array_length(regexp_split_to_array(c.body, E'\\\\s+'), 1))
# Character count is calculated using: sum(length(c.body))
#
# These data can easily be reproduced in R from the JSON data:

# Calculates word count for each comment
count_words <- function(comment) {
   sum(attr(gregexpr("\\s+", comment)[[1]], "match.length")) + 1
}

# Calculates character count for each comment
count_characters <- function(comment) {
    nchar(comment)
}

# Convenience function to string the word count and character count into a list
count_words_and_characters <- function(comment) {
    c(count_words(comment), count_characters(comment))
}

# Returns (1, 1) for on time comments and (0, 1) for late comments. The lists
# can be summed up later to obtain, for each student, the total number of on
# time comments and the total number of comments
is_on_time <- function(x) {
  # When summed, becomes:
  # On.Time                                                                        Total.Comments
  c(ifelse(as.POSIXct(x, format='%FT%T') < as.POSIXct(due_date), 1, 0), 1)
}

# Figure out which comments are on time and sum the number of on-time comments
# (this part: sapply(FUN = is_on_time, data[, 'Time']))
# for each e-mail address
# (the outer part: aggregate by list(data[, 'Email']) using sum)
on_time_count <- aggregate(
    t(sapply(FUN = is_on_time, data[, 'Time'])),
    by = list(data[, 'Email']),
    FUN = sum)

# Sum word counts and character counts for each e-mail address
comment_statistics <- aggregate(
    t(sapply(data[, "Comment"], FUN = count_words_and_characters)),
    by = list(data[, "Email"]),
    FUN = sum)

# Clarify what output columns are
names(comment_statistics) <- c("Email.Address", "Word.Count", "Character.Count")
names(on_time_count) <- c("Email.Address", "On.Time", "Total.Comments")

# Merge the two statistics data.frames
stats <- data.frame(merge(comment_statistics, on_time_count, by = "Email.Address"), Score = 0)

####Evaluate and assign score ###CHANGE VALUES HERE

# Students with at least 4 comments and a total of 35 words across the 4
# comments get 5 points
sel <- (stats$Total.Comments >= 4 & stats$Word.Count >= 35)
stats$Score[sel] <- 5
sel <- (stats$Total.Comments >= 3 & stats$Word.Count < 35)
stats$Score[sel] <- 3
sel <- (stats$Total.Comments == 2 & stats$Word.Count >= 20) & (stats$Total.Comments == 2 & stats$Word.Count < 400)
stats$Score[sel] <- 3
sel <- (stats$Total.Comments == 2 & stats$Word.Count < 20)
stats$Score[sel] <- 2
sel <- (stats$Total.Comments == 1 & stats$Word.Count <= 400)
stats$Score[sel] <- 1

##merge scores with roster via email address
mg <- merge(rost, stats, "Email.Address", all.x = TRUE) ## contains email and stu id

# Modify grades based on whether or not comments were on time
# Replace NAs from merge with 0s (or we'll get a can't divide error later)
mg$On.Time[is.na(mg$On.Time)] <- 0
mg$Total.Comments[is.na(mg$Total.Comments)] <- 0
mg$Word.Count[is.na(mg$Word.Count)] <- 0
mg$Character.Count[is.na(mg$Character.Count)] <- 0
mg$Score[is.na(mg$Score)] <- 0

# Use a maximum of 4 on-time comments (that way, if a student gave 11 on-time
# comments, they don't get extra credit)
mg$On.Time[mg$On.Time > 4] <- 4

# Can't divide by 0, so make each Total.Comments at least 1, but no greater than 4
mg$Total.Comments[mg$Total.Comments < 1] <- 1
mg$Total.Comments[mg$Total.Comments > 4] <- 4

# Apply partial credit linearly (1 comment = 25% of grade, 2 = 50% of grade, 3 =
# 75% of grade, 4+ = 100% of grade); modify as necessary.
mg$Score <- mg$Score * (mg$On.Time / mg$Total.Comments)

# Write New Workbook for sorting and spot checks (contains all data used for
# grading and then some)
output1 <- createWorkbook()
sheet <- createSheet(output1, sheetName="results")
addDataFrame(mg, sheet)
saveWorkbook(output1, paste(outfilename, "_processed_45_25_", instruct, ".xlsx", sep=""))

####Write new notebook for uploading assignment to smartsite
# No-structure gradebook (only grades). Grade and student data. Use this
# approach if you have already set up your gradebook and you want to add
# scores/comments for new grade items, or you want to add or overwrite
# scores/comments for existing items.

###Create New Data Frame For Output
data2 <- data.frame(Student.Id=mg$User.ID, New.Item=mg$Score)

#Rename Columns to SmartSite-Friendly Format
names(data2) = c("Student Id", paste("NB", assign_num, "[5]", sep=""))

####Write new file
output2 <- createWorkbook()
sheet <- createSheet(output2, sheetName="sheet0")
addDataFrame(data2, sheet, row.names=FALSE)
saveWorkbook(output2, paste(outfilename, "_processed_45_25_", instruct, "_upload.xlsx", sep=""))
###
##### Import the above file into smartsite. Appears in the working directory (NB folder) ###

